import pandas as pd


# ======================================================
# СПРАВОЧНИК ГРУПП ЛОКУСОВ
# ======================================================


LOCUS_COLORS = {
    "Кровь венозная": "#1f77b4",
    "Дистальный конец ЦВК": "#9467bd",
    "Жидкость амниотическая": "#8c564b",
    "Аутопсийный материал кровь": "#e41a1c",
    "Аутопсийный материал легкое": "#377eb8",
    "Аутопсийный материал печень": "#984ea3",
    "Молоко грудное": "#ffffb3",
    "Эякулят": "#bc80bd",

    "Аспират эндотрахеальный": "#2ca02c",
    "Аспират трахеобронхиальный": "#66c2a5",
    "Отделяемое раны": "#fc8d62",
    "Мокрота": "#cab2d6",
    "Моча": "#80b1d3",
    "Кал": "#8dd3c7",
    "Мазок вагинальный": "#e78ac3",
    "Мазок вагино-ректальный": "#a6d854",
    "Отделяемое слизистой уретры": "#b2df8a",
    "Отделяемое слизистой цервикального канала": "#ffd92f",

    "Мазок ректальный": "#fb8072",
    "Мазок слизистой ротоглотки и носоглотки": "#fdb462",
    "Отделяемое слизистой носа": "#b3de69",
}

LOCUS_GROUPS = {
    "Стерильные": [
        "Кровь венозная",
        "Дистальный конец ЦВК",
        "Жидкость амниотическая",
        "Аутопсийный материал кровь",
        "Аутопсийный материал легкое",
        "Аутопсийный материал печень",
        "Молоко грудное",
        "Эякулят"
    ],
    "Нестерильные": [
        "Аспират эндотрахеальный",
        "Аспират трахеобронхиальный",
        "Отделяемое раны",
        "Мокрота",
        "Моча",
        "Кал",
        "Мазок вагинальный",
        "Мазок вагино-ректальный",
        "Отделяемое слизистой уретры",
        "Отделяемое слизистой цервикального канала"
    ],
    "Скрининговые": [
        "Мазок ректальный",
        "Мазок слизистой ротоглотки и носоглотки",
        "Отделяемое слизистой носа"
    ]
}


# ======================================================
# КЛАССИФИКАЦИЯ
# ======================================================

def classify_locus(locus: str) -> str:
    for group, items in LOCUS_GROUPS.items():
        if locus in items:
            return group
    return "Не классифицировано"


# ======================================================
# ОСНОВНОЙ АНАЛИЗ
# ======================================================

def analyze_loci(excel_path: str) -> dict:
    """
    Анализ биоматериалов (локусов).
    Структура полностью совместима с GUI.
    """

    df = pd.read_excel(excel_path)

    # --- проверка ---
    if "Локус" not in df.columns or "COUNT(*)" not in df.columns:
        raise ValueError("В Excel должны быть колонки 'Локус' и 'COUNT(*)'")

    df = df[["Локус", "COUNT(*)"]]
    df.columns = ["locus", "count"]

    # --- очистка ---
    df["locus"] = df["locus"].astype(str).str.strip()
    df = df[df["locus"] != "Не указано"]

    df["group"] = df["locus"].apply(classify_locus)

    total = int(df["count"].sum())

    # ==================================================
    # АГРЕГАЦИЯ
    # ==================================================

    groups_dict = {}
    unclassified = []

    for group, gdf in df.groupby("group"):
        g_total = int(gdf["count"].sum())

        groups_dict[group] = {
            "group": group,
            "count": g_total,
            "percent": round(g_total / total * 100, 1) if total else 0,
            "items": []
        }

        for locus, ldf in gdf.groupby("locus"):
            c = int(ldf["count"].sum())
            groups_dict[group]["items"].append({
                "name": locus,
                "count": c,
                "percent": round(c / g_total * 100, 1) if g_total else 0
            })

            if group == "Не классифицировано":
                unclassified.append({
                    "locus": locus,
                    "count": c
                })

        # сортировка локусов внутри группы
        groups_dict[group]["items"].sort(
            key=lambda x: x["count"],
            reverse=True
        )

    # сортировка групп
    groups = sorted(
        groups_dict.values(),
        key=lambda x: x["count"],
        reverse=True
    )

    return {
        "total": total,
        "groups": groups,
        "unclassified": unclassified
    }
